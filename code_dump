@application.after_request
def add_header(response):
    # response.cache_control.no_store = True
    if 'Cache-Control' not in response.headers:
        response.headers['Cache-Control'] = 'no-store'
    return response

d3 dc leaflet crossfilter jquery underscore
#event response
from slackeventsapi import SlackEventAdapter
from slackclient import SlackClient

SLACK_VERIFICATION_TOKEN =

slack_events_adapter = SlackEventAdapter(SLACK_VERIFICATION_TOKEN, endpoint="/slack/events")

# Create a SlackClient for your bot to use for Web API requests
SLACK_BOT_TOKEN =

# Example responder to greetings
@slack_events_adapter.on("message")
def handle_message(event_data):
    message = event_data["event"]
    ts = message['ts']
    tk = event_data['api_app_id']
    # If the incoming message contains "hi", then respond with a "Hello" message
    if message.get("subtype") is None and ("hi" in message.get('text') or "HI" in message.get('text')):
        channel = message["channel"]
        text = "Hello <@%s>! :tada:" % message["user"]
        # for record in postman_tokens:
            # if record['token'] == tk:    bot_token = record['bot_token']
        SlackClient(SLACK_BOT_TOKEN).api_call("reactions.add", channel=channel, name="football", timestamp=ts)
        SlackClient(SLACK_BOT_TOKEN).api_call("chat.postMessage", channel=channel, text=text)


slack_events_adapter.start(port=5000)

# send msg to user directly 
from slackclient import SlackClient
import json
import datetime

BOT_TOKEN = 'xoxb'

slack_client = SlackClient(BOT_TOKEN)
yesterday = datetime.datetime.today() - datetime.timedelta(days=1)

rt1 = ""
for i in range(8):
    rt1 += str(i) + '--' + str(i) + '\n'

rt2 = ""
for i in range(5):
    rt2 += str(i) + '--' + str(i) + '\n'


if __name__ == '__main__':
    #chan = "C6VRAB7FV"
    api_call = slack_client.api_call("im.list")
    attachment = json.dumps([
    {
    "fallback": "New ticket from Andrea Lee - Ticket #1943: Can't reset my password - https://groove.hq/path/to/ticket/1943",
    "pretext": "gy",
    "author_name": "G1",
    "author_link": "http://flickr.com/bobby/",
    "author_icon": "http://americanfootballfilms.com/wp-content/uploads/2012/11/nfl-logo.jpg",
    "text": rt1,
    "color": "#7CD197"
    },
    {
     "fallback": "New ticket from Andrea Lee - Ticket #1943: Can't reset my password - https://groove.hq/path/to/ticket/1943",
     "title": ":baseball: G2",
     "title_link": "https://groove.hq/path/to/ticket/1943",
     "text": rt2,
     "color": "#0594CC",
     },
    {
        "text": "_type_ `m` _check more_ ",
        "mrkdwn_in": ["text"]
    }
])

    if api_call.get('ok'):
        for im in api_call.get("ims"):
            im_channel = im.get("id")
            slack_client.api_call("chat.postMessage", channel=im_channel,
                                  text=yesterday.date(), attachments=attachment, as_user=True)

# safe url flask 
def generate_url():
    global secret
    secret = urandom(2)  # such as generate from os.urandom(length) ***
    current_time = str(int(time.time()))
    token = hmac.new(secret, current_time.encode('utf-8'), hashlib.sha256).hexdigest()
    return "http://94d013b9.ngrok.io/pageview?time=%(current_time)s&token=%(token)s" % {   #change local host each time on ngrok and slack api
        "current_time": current_time,
        "token": token
    }

def verify(time_in_link, token_in_link):
    time_limit = 12  # sec
    if (time.time() - int(time_in_link)) > time_limit:  #timeout
        print("figure expired")
        return False
    if hmac.new(secret, time_in_link.encode('utf-8'), hashlib.sha256).hexdigest() == token_in_link:  # Check the token is available or not
        print("token is correct")
        return True
    else:
        print("incorrect token")
        return False


@application.route("/slack", methods=['POST'])  #json img done
def parse_request():
    if request.form.get('user_name') in ['kyang', 'test'] and request.form.get('token') == app_token and request.form.get('text') == 'aws':
        link = generate_url()
        return jsonify({
        'text': 'Pageview',
        'attachments': [
            {
                'fallback': 'Required plain-text summary of the attachment.',
                'color': '#36a64f',
                'title': 'Pageview AWS Demo',
                "color": "#36a64f",
                'title_link': "https://www.kryteriononline.com/",
                'image_url': link,
                "ts": int(time.time())
            }
        ]
    })
    else:
        return Response("Not a valid argument", status=405)

@application.route("/pageview", methods=['GET'])
def png():
    if verify(request.args.get('time'), request.args.get('token')):
        return pageview()
    else:
        return Response("Sorry, this figure is expired and only available on Slack.\n  -Kyle(kyang@kryteriononline.com)", status=405)


if __name__ == "__main__":
    application.run(debug=False)


##############
from nba_py import Scoreboard, game
import pandas as pd
from itertools import groupby


test = Scoreboard(10, 26, 2016)
sb = test.game_header()
sb = sb[['GAME_ID', 'VISITOR_TEAM_ID', 'HOME_TEAM_ID']]
sc = test.line_score()
sc= sc.sort_values('GAME_SEQUENCE')
sc = sc[['GAME_ID', 'TEAM_ID', 'PTS']]

df_merged = pd.merge(sb, sc, left_on=['GAME_ID'],
              right_on=['GAME_ID'],
              how='outer')
df_merged['PTS'] = df_merged['PTS'].astype('int')

def visitor_pts(row):
    if row['VISITOR_TEAM_ID'] == row['TEAM_ID']:
        return row['PTS']
    else:
        return 0

def home_pts(row):
    if row['HOME_TEAM_ID'] == row['TEAM_ID']:
        return row['PTS']
    else:
        return 0

df_merged['VISITOR_PTS'] = df_merged.apply(visitor_pts, axis=1)
df_merged['HOME_PTS'] = df_merged.apply(home_pts, axis=1)
df_merged.drop(['PTS', 'TEAM_ID'], axis=1, inplace=True)
df_merged = df_merged.groupby(['GAME_ID', 'VISITOR_TEAM_ID', 'HOME_TEAM_ID']).sum().reset_index()

name_mapping = {
    1610612748: 'A',
    1610612753: 'B',
    1610612742: 'C',
    1610612754: 'D'
}

f = lambda x: name_mapping.get(x, x)
df_merged['VISITOR_TEAM_ID'] = df_merged['VISITOR_TEAM_ID'].map(f)
df_merged['HOME_TEAM_ID'] = df_merged['HOME_TEAM_ID'].map(f)

def scores(df):
    text = ''
    for index, row in df.iterrows():
        text += str(row['VISITOR_TEAM_ID']) + '(' + str(row['VISITOR_PTS']) + ') at ' + str(row['HOME_TEAM_ID']) + '(' + str(row['HOME_PTS']) + ')\n'
    if text == '':
        return 'no'
    else:
        return text

print(scores(df_merged))

from nba_py import Scoreboard, game
import pandas as pd
from itertools import groupby

#### sch
test = Scoreboard(9, 30, 2017)
sb = test.game_header()

def schedule(df):
    text = ''
    for index, row in df.iterrows():
        text += str(row['VISITOR_TEAM_ID']) +  ' at ' + str(row['HOME_TEAM_ID']) + ' -- ' + row['GAME_STATUS_TEXT'] +'\n'
    if text == '':
        return 'no'
    else:
        return text
